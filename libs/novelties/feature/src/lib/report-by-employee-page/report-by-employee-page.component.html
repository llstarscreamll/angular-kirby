<h1 class="mb-4">Reporte de novedades de empleado</h1>

<kirby-api-errors [apiError]="errors$ | async"></kirby-api-errors>

<form [formGroup]="searchForm" (submit)="searchSubmitted()" class="mb-5">
  <mat-form-field class="w-100">
    <input
      matInput
      placeholder="Empleado"
      [matAutocomplete]="employeeAutocomplete"
      formControlName="employee"
    />
    <mat-autocomplete
      #employeeAutocomplete="matAutocomplete"
      [displayWith]="displayEmployeeFieldValue"
    >
      <mat-option
        *ngFor="let employee of (foundEmployees$ | async)?.data"
        [value]="employee"
      >
        <span>{{ employee.first_name + ' ' + employee.last_name }}</span>
      </mat-option>
    </mat-autocomplete>
  </mat-form-field>

  <mat-form-field class="w-50">
    <input
      formControlName="start_date"
      placeholder="Fecha inicial"
      type="date"
      matInput
    />
  </mat-form-field>

  <mat-form-field class="w-50">
    <input
      formControlName="end_date"
      placeholder="Fecha final"
      type="date"
      matInput
    />
  </mat-form-field>

  <div class="text-center">
    <button
      [disabled]="searchForm.invalid"
      mat-raised-button
      color="primary"
      type="submit"
    >
      Generar
    </button>
  </div>
</form>

<div class="table-responsive">
  <table class="table">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>SCC</th>
        <th>Total Hrs.</th>
        <th>Novedades</th>
        <th>Comentarios</th>
        <th>Aprobadores</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let row of (noveltiesReport$ | async)?.data">
        <td>{{ row.date | date }}</td>
        <td>
          <div *ngFor="let scc of row.subCostCenters">{{ scc.code }}</div>
        </td>
        <td>{{ row.totalHours }}</td>
        <td>
          <a
            *ngFor="let novelty of row.novelties"
            [routerLink]="['..', novelty.id, 'edit']"
            class="d-block"
          >
            {{ novelty.total_time_in_hours }}
            {{ novelty.novelty_type.code }}
          </a>
        </td>
        <td>{{ row.comments.length }}</td>
        <td>
          <div *ngFor="let approver of row.approvals">
            {{ approver.first_name + ' ' + approver.last_name }}
          </div>
        </td>
        <td>
          <button
            *ngIf="row.userHasAnyToApprove(user.id)"
            (click)="setApproval(row.employee.id, row.date)"
            matTooltip="Aprobar todo en este día"
            mat-icon-button
            color="primary"
            class="approve"
          >
            <mat-icon>check_circle</mat-icon>
          </button>
          <button
            *ngIf="row.userHasApprovals(user)"
            (click)="deleteApprovals(row)"
            matTooltip="Borrar aprobaciones de este día"
            mat-icon-button
            color="warn"
            class="delete-approval"
          >
            <mat-icon>remove_circle</mat-icon>
          </button>
        </td>
      </tr>

      <tr *ngIf="(noveltiesReport$ | async)?.length === 0">
        <td colspan="7" class="text-center">No se encontraron datos</td>
      </tr>

      <tr *ngIf="!(noveltiesReport$ | async)">
        <td colspan="7" class="text-center">
          Elige un empleado para generar el reporte
        </td>
      </tr>
    </tbody>
  </table>
</div>
